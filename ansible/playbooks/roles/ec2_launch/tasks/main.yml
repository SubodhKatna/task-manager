# SPDX-License-Identifier: MIT-0
---
# ✅ Install packages based on OS (Ubuntu runner OR Amazon Linux EC2)
- name: Install common packages (Apache + Node + npm)
  become: yes
  package:
    name:
      - "{{ 'httpd' if ansible_os_family == 'RedHat' else 'apache2' }}"
      - nodejs
      - npm
    state: present

# ✅ Start correct web service based on OS
- name: Start and enable web server
  become: yes
  service:
    name: "{{ 'httpd' if ansible_os_family == 'RedHat' else 'apache2' }}"
    state: started
    enabled: yes

# ✅ Copy GitHub repo to matching folder name
- name: Copy Source Code
  become: yes
  synchronize:
    src: "{{ playbook_dir }}/../../"
    dest: "/opt/task-manager"
    delete: yes
    recursive: yes
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=.github"
      - "--exclude=ansible"

# ✅ Wait for EC2 SSH only if instance exists
- name: Wait for instance to be ready
  wait_for:
    host: "{{ ec2.instances[0].public_dns_name }}"
    port: 22
    delay: 20
    timeout: 300
    state: started
  when: ec2.instances is defined and ec2.instances | length > 0

# ✅ Add EC2 to inventory dynamically
- name: Add the EC2 instance to inventory
  add_host:
    name: "{{ ec2.instances[0].public_dns_name }}"
    groups: launched_ec2_instances
    ansible_ssh_private_key_file: "{{ ec2_ssh_key_path }}"
    ansible_user: ec2-user
  when: ec2.instances is defined and ec2.instances | length > 0

# ✅ Debug info
- name: Debug SSH Key Path
  debug:
    var: ec2_ssh_key_path

- name: Debug Dynamic Inventory
  debug:
    var: groups['launched_ec2_instances']
