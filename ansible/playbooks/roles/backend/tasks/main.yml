- name: Install backend dependencies
  become: yes
  npm:
    path: /opt/task-manager/backend
    ci: yes

- name: Create backend .env
  copy:
    dest: /opt/task-manager/backend/.env
    content: |
      PORT={{ PORT }}
      MONGO_URI={{ MONGO_URI }}
      JWT_SECRET={{ JWT_SECRET }}
      ADMIN_INVITE_CODE={{ ADMIN_INVITE_CODE }}
    owner: ec2-user
    group: ec2-user

- name: Install PM2 globally
  become: yes
  npm:
    name: pm2
    global: yes

- name: Start backend using PM2
  become: yes
  command: pm2 start npm --name "backend" -- start
  args:
    chdir: /opt/task-manager/backend

- name: Save PM2 process list
  become: yes
  command: pm2 save

- name: Enable PM2 startup service
  become: yes
  command: pm2 startup -u ec2-user --hp /home/ec2-user

- debug:
    msg: "âœ… Backend running & auto-start enabled"
