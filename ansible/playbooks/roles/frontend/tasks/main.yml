- name: Ensure frontend directory exists
  file:
    path: /opt/task-manager/frontend
    state: directory
    owner: ec2-user
    group: ec2-user

- name: Create .env for Vite
  copy:
    dest: /opt/task-manager/frontend/.env
    content: |
      VITE_API_URL=http://{{ inventory_hostname }}:3000
    owner: ec2-user
    group: ec2-user
    mode: "0600"

- name: Install frontend dependencies
  become: yes
  npm:
    path: /opt/task-manager/frontend
    ci: yes

- name: Build frontend
  become: yes
  command: npm run build
  args:
    chdir: /opt/task-manager/frontend

- name: Fix build permissions
  become: yes
  file:
    path: /opt/task-manager/frontend/dist
    owner: ec2-user
    group: ec2-user
    recurse: yes

- name: Install serve globally (for static frontend hosting)
  become: yes
  npm:
    name: serve
    global: yes

- name: Start frontend using PM2
  become: yes
  command: pm2 start serve --name "frontend" -- /opt/task-manager/frontend/dist -l 80
  args:
    chdir: /opt/task-manager/frontend

- name: Save PM2 process list
  become: yes
  command: pm2 save

- name: Configure PM2 startup on server reboot
  become: yes
  command: pm2 startup systemd -u ec2-user --hp /home/ec2-user

- debug:
    msg: "âœ… Frontend deployed & started via PM2. Run 'pm2 list' on the server to verify. Access via the instance public IP shown in EC2 console."
